<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Digital Ace ‚Äî TikTok Growth Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
/* ============================================
   THEME ‚Äî Digital Ace Brand
   Primary: #C23B3B | Complement: #2BC5B4
   ============================================ */
:root{--brand:#C23B3B;--brand-light:#E05555;--brand-dim:rgba(194,59,59,.12);--complement:#2BC5B4;--complement-dim:rgba(43,197,180,.12);--green:#34D399;--red:#F87171;--amber:#FBBF24;--purple:#A78BFA;--radius:14px;--radius-sm:8px;--font:'Plus Jakarta Sans',sans-serif;--mono:'JetBrains Mono',monospace;--tr:.2s cubic-bezier(.4,0,.2,1);}
[data-theme="dark"]{--bg-0:#0C0C14;--bg-1:#13131F;--bg-2:#1C1C2E;--bg-3:#252540;--bg-h:#2A2A48;--brd:rgba(255,255,255,.06);--brd2:rgba(255,255,255,.1);--t1:#F5F5FA;--t2:#A0A0BE;--t3:#6B6B88;--shd:0 2px 12px rgba(0,0,0,.3);}
[data-theme="light"]{--bg-0:#F4F1EE;--bg-1:#FFF;--bg-2:#F9F7F5;--bg-3:#EDEAE7;--bg-h:#E8E4E0;--brd:rgba(0,0,0,.06);--brd2:rgba(0,0,0,.1);--t1:#1A1A2E;--t2:#6B6B88;--t3:#9E9EB5;--shd:0 2px 12px rgba(0,0,0,.06);}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--font);background:var(--bg-0);color:var(--t1);min-height:100vh;}
::-webkit-scrollbar{width:5px;height:5px;} ::-webkit-scrollbar-track{background:transparent;} ::-webkit-scrollbar-thumb{background:var(--brd2);border-radius:9px;}

.hdr{padding:14px 24px;display:flex;align-items:center;justify-content:space-between;background:var(--bg-1);border-bottom:1px solid var(--brd);position:sticky;top:0;z-index:100;backdrop-filter:blur(12px);}
.hdr-l{display:flex;align-items:center;gap:12px;}
.logo{font-weight:800;font-size:18px;color:var(--brand);letter-spacing:-.8px;display:flex;align-items:center;gap:7px;}
.logo .d{width:7px;height:7px;border-radius:50%;background:var(--complement);} .logo span{color:var(--t3);font-weight:500;font-size:11px;letter-spacing:.8px;text-transform:uppercase;}
.hdr-r{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}

.b{padding:6px 12px;border-radius:var(--radius-sm);border:1px solid var(--brd2);background:var(--bg-2);color:var(--t1);font-family:var(--font);font-size:11px;font-weight:600;cursor:pointer;transition:var(--tr);display:flex;align-items:center;gap:4px;}
.b:hover{background:var(--bg-h);} .b-brand{background:var(--brand);border-color:var(--brand);color:#fff;} .b-brand:hover{background:var(--brand-light);}

.thm{position:relative;width:48px;height:26px;border-radius:13px;background:var(--bg-3);border:1px solid var(--brd2);cursor:pointer;transition:var(--tr);}
.thm::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:var(--brand);transition:var(--tr);}
[data-theme="light"] .thm::after{left:25px;background:var(--complement);}
.thm .i{position:absolute;top:4px;font-size:12px;} .thm .m{left:6px;} .thm .s{right:6px;}

.tabs{display:flex;gap:0;padding:0 24px;background:var(--bg-1);border-bottom:1px solid var(--brd);}
.tab{padding:10px 16px;font-size:11px;font-weight:600;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;transition:var(--tr);user-select:none;}
.tab:hover{color:var(--t2);} .tab.a{color:var(--brand);border-bottom-color:var(--brand);}

.mn{padding:18px 24px;max-width:1560px;margin:0 auto;}

/* Stats */
.sr{display:grid;gap:10px;margin-bottom:18px;}
.sc{background:var(--bg-1);border:1px solid var(--brd);border-radius:var(--radius);padding:16px 18px;position:relative;overflow:hidden;box-shadow:var(--shd);transition:var(--tr);}
.sc:hover{transform:translateY(-1px);} .sc .ab{position:absolute;top:0;left:0;right:0;height:3px;}
.sl{font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.7px;font-weight:700;margin-bottom:6px;}
.sv{font-family:var(--mono);font-size:22px;font-weight:700;margin-bottom:1px;}
.ss{font-size:10px;color:var(--t3);display:flex;align-items:center;gap:3px;}
.ss .u{color:var(--green);font-weight:700;} .ss .d{color:var(--red);font-weight:700;}

/* Cards */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;}
.gf{margin-bottom:18px;}
.cd{background:var(--bg-1);border:1px solid var(--brd);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shd);}
.ch{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--brd);flex-wrap:wrap;gap:6px;}
.ct{font-size:12px;font-weight:700;} .cb{padding:16px;}
.cc{width:100%;height:260px;}

/* Table */
.ts{max-height:460px;overflow-y:auto;}
.dt{width:100%;border-collapse:collapse;font-size:11px;}
.dt thead th{padding:8px 10px;text-align:left;font-weight:700;color:var(--t3);font-size:9px;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid var(--brd2);position:sticky;top:0;background:var(--bg-1);z-index:1;}
.dt tbody td{padding:8px 10px;border-bottom:1px solid var(--brd);font-family:var(--mono);font-size:10px;}
.dt tbody tr:hover{background:var(--bg-h);}

.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:5px;font-size:9px;font-weight:700;font-family:var(--font);}
.tag{display:inline-flex;padding:1px 6px;border-radius:3px;font-size:8px;font-weight:700;font-family:var(--font);background:var(--bg-3);color:var(--t2);margin:1px;}
.tag.nc{background:rgba(251,191,36,.15);color:var(--amber);}
.cp{color:var(--green);} .cn{color:var(--red);} .cz{color:var(--t3);}

/* Pills */
.pls{display:flex;gap:4px;flex-wrap:wrap;}
.pl{padding:4px 10px;border-radius:16px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid var(--brd2);background:var(--bg-2);color:var(--t3);transition:var(--tr);user-select:none;}
.pl:hover{background:var(--bg-h);} .pl.a{color:#fff;}

/* Calendar */
.csc{overflow:auto;max-height:68vh;}
.cg{display:grid;min-width:max-content;}
.chc{padding:7px 5px;font-family:var(--font);font-weight:700;font-size:9px;color:var(--t3);border-right:1px solid var(--brd);border-bottom:2px solid var(--brd2);text-align:center;min-width:60px;position:sticky;top:0;background:var(--bg-1);z-index:2;}
.chc.td{color:var(--brand);background:var(--brand-dim);}
.crl{padding:6px 8px;font-family:var(--font);font-weight:600;font-size:10px;border-right:2px solid var(--brd2);border-bottom:1px solid var(--brd);position:sticky;left:0;background:var(--bg-1);z-index:3;white-space:nowrap;display:flex;align-items:center;gap:4px;min-width:110px;}
.ccr{position:sticky;left:0;top:0;z-index:5;background:var(--bg-1);border-right:2px solid var(--brd2);border-bottom:2px solid var(--brd2);padding:7px 8px;font-size:9px;font-weight:700;color:var(--t3);min-width:110px;}
.cdv{grid-column:1/-1;padding:4px 8px;font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--brd2);position:sticky;left:0;z-index:4;}
.ccl{padding:6px 4px;border-right:1px solid var(--brd);border-bottom:1px solid var(--brd);font-family:var(--mono);font-size:9px;text-align:center;min-width:60px;position:relative;cursor:pointer;transition:background var(--tr);}
.ccl:hover{background:var(--bg-h);}
.ccl.hv::after{content:'';position:absolute;top:2px;right:2px;width:4px;height:4px;border-radius:50%;background:var(--brand);}
.ccl input{width:100%;background:transparent;border:1px solid var(--brand);border-radius:3px;color:var(--t1);font-family:var(--mono);font-size:9px;text-align:center;padding:1px;outline:none;}
.hmc{padding:5px 3px;border-right:1px solid var(--brd);border-bottom:1px solid var(--brd);font-family:var(--mono);font-size:9px;text-align:center;min-width:55px;position:relative;}
.hmc .bg{position:absolute;inset:2px;border-radius:3px;z-index:0;} .hmc .vl{position:relative;z-index:1;font-weight:600;}

/* Modal */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:200;display:none;align-items:center;justify-content:center;}
.mo.a{display:flex;}
.ml{background:var(--bg-1);border:1px solid var(--brd2);border-radius:var(--radius);width:520px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.4);}
.mh{padding:16px 20px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;} .mh h2{font-size:14px;font-weight:800;}
.mx{width:28px;height:28px;border-radius:var(--radius-sm);border:none;background:var(--bg-3);color:var(--t2);cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;} .mx:hover{background:var(--bg-h);}
.mb{padding:20px;} .mf{padding:12px 20px;border-top:1px solid var(--brd);display:flex;justify-content:flex-end;gap:6px;}
.fg{margin-bottom:12px;} .fl{display:block;font-size:10px;font-weight:700;color:var(--t3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.3px;}
.fi,.fs{width:100%;padding:8px 10px;border-radius:var(--radius-sm);border:1px solid var(--brd2);background:var(--bg-2);color:var(--t1);font-family:var(--font);font-size:12px;outline:none;transition:var(--tr);}
.fi:focus,.fs:focus{border-color:var(--brand);} .fr{display:grid;grid-template-columns:1fr 1fr;gap:8px;} .fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}

/* Toast */
.toast{position:fixed;bottom:18px;right:18px;background:var(--green);color:#000;padding:9px 16px;border-radius:var(--radius-sm);font-size:11px;font-weight:700;z-index:300;transform:translateY(50px);opacity:0;transition:all .3s ease;} .toast.sh{transform:translateY(0);opacity:1;}

/* Drop zone */
.dz{border:2px dashed var(--brd2);border-radius:var(--radius);padding:24px;text-align:center;cursor:pointer;transition:var(--tr);}
.dz:hover,.dz.dg{border-color:var(--brand);background:var(--brand-dim);} .dz input{display:none;}

/* Sync indicator */
.sync{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;margin-right:4px;animation:pulse 2s infinite;}
.sync.off{background:var(--red);animation:none;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}} .cd,.sc{animation:fadeUp .3s ease;}
.vli{padding:9px 10px;border:1px solid var(--brd);border-radius:var(--radius-sm);margin-bottom:5px;display:flex;align-items:center;gap:8px;font-size:10px;}
.vlt{font-family:var(--mono);color:var(--brand);font-weight:700;min-width:42px;}

@media(max-width:900px){.sr{grid-template-columns:repeat(2,1fr)!important;}.g2{grid-template-columns:1fr;}.mn{padding:12px;}.hdr{padding:10px 12px;}.tabs{padding:0 12px;overflow-x:auto;}}
</style>
</head>
<body>

<header class="hdr">
  <div class="hdr-l"><div class="logo"><div class="d"></div>DIGITAL ACE<span>Growth Tracker</span></div><span class="sync" id="syncDot" title="Conectado ao servidor"></span></div>
  <div class="hdr-r">
    <div class="thm" onclick="toggleTheme()" title="Tema"><span class="i m">üåô</span><span class="i s">‚òÄÔ∏è</span></div>
    <button class="b" onclick="openCountryModal()">üåç</button>
    <button class="b" onclick="openImportModal()">üì• Import</button>
    <button class="b" onclick="exportCSV()">üìä Export</button>
    <button class="b" onclick="openVideoModal()">üé¨</button>
    <button class="b b-brand" onclick="openDailyModal()">+ Dados</button>
  </div>
</header>

<nav class="tabs">
  <div class="tab a" onclick="swTab('overview',this)">Vis√£o Geral</div>
  <div class="tab" onclick="swTab('calendar',this)">üìÖ Calend√°rio</div>
  <div class="tab" onclick="swTab('accounts',this)">Contas</div>
  <div class="tab" onclick="swTab('videos',this)">V√≠deos</div>
  <div class="tab" onclick="swTab('timeline',this)">Timeline</div>
</nav>

<main class="mn">
<!-- OVERVIEW -->
<div id="tab-overview">
  <div class="sr" id="statsRow"></div>
  <div class="g2">
    <div class="cd"><div class="ch"><span class="ct">Crescimento por Pa√≠s</span><div class="pls" id="cpf"></div></div><div class="cb"><div class="cc"><canvas id="gChart"></canvas></div></div></div>
    <div class="cd"><div class="ch"><span class="ct">Top Contas</span></div><div class="cb"><div class="cc"><canvas id="aChart"></canvas></div></div></div>
  </div>
  <div class="gf"><div class="cd">
    <div class="ch"><span class="ct">üìÖ Vis√£o Di√°ria</span><div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;"><div class="pls" id="ocp"></div><input type="date" class="fi" id="ogF" onchange="rGrid()" style="width:120px;padding:3px 6px;font-size:10px;"><input type="date" class="fi" id="ogT" onchange="rGrid()" style="width:120px;padding:3px 6px;font-size:10px;"><div class="pls" id="omp"><span class="pl a" style="background:var(--t3);color:#fff;" onclick="sGM('hm',this)">Heatmap</span><span class="pl" onclick="sGM('ch',this)">Gr√°fico</span></div></div></div>
    <div class="cb" style="padding:0;"><div id="ogW"><div class="csc" style="max-height:380px;"><div id="ogC"></div></div></div><div id="ocW" style="display:none;padding:16px;"><div style="height:300px;"><canvas id="odChart"></canvas></div></div></div>
  </div></div>
  <div class="gf"><div class="cd">
    <div class="ch"><span class="ct">Dados Recentes</span><div class="pls" id="tcf"></div></div>
    <div class="cb" style="padding:0;"><div class="ts"><table class="dt"><thead><tr><th>Pa√≠s</th><th>Conta</th><th>Data</th><th>Followers</th><th>Œî</th><th>V√≠deos</th><th>Tags</th></tr></thead><tbody id="mtb"></tbody></table></div></div>
  </div></div>
</div>

<!-- CALENDAR -->
<div id="tab-calendar" style="display:none;"><div class="gf"><div class="cd">
  <div class="ch"><span class="ct">üìÖ Calend√°rio</span><div style="display:flex;align-items:center;gap:8px;"><div class="pls" id="cdm"><span class="pl a" style="background:var(--t3);color:#fff;" onclick="sCD('f',this)">Followers</span><span class="pl" onclick="sCD('d',this)">Œî Varia√ß√£o</span><span class="pl" onclick="sCD('v',this)">V√≠deos</span></div><select class="fs" id="ccf" onchange="rCal()" style="width:100px;padding:4px;font-size:10px;"></select></div></div>
  <div class="cb" style="padding:0;"><div class="csc" id="cScr"><div id="cGrid"></div></div></div>
</div></div></div>

<!-- ACCOUNTS -->
<div id="tab-accounts" style="display:none;"><div class="gf"><div class="cd">
  <div class="ch"><span class="ct">Contas</span><button class="b b-brand" onclick="openAccModal()">+ Nova</button></div>
  <div class="cb" style="padding:0;"><div class="ts"><table class="dt"><thead><tr><th>Pa√≠s</th><th>ID</th><th>Nicho</th><th>Followers</th><th>Criada</th><th>Status</th><th></th></tr></thead><tbody id="atb"></tbody></table></div></div>
</div></div></div>

<!-- VIDEOS -->
<div id="tab-videos" style="display:none;"><div class="gf"><div class="cd">
  <div class="ch"><span class="ct">V√≠deos & Nicho</span><div style="display:flex;gap:5px;"><button class="b" onclick="openNicheModal()">üîÑ Nicho</button><button class="b b-brand" onclick="openVideoModal()">+ V√≠deo</button></div></div>
  <div class="cb"><div id="vlc"><p style="color:var(--t3);font-size:11px;text-align:center;padding:30px;">Nenhum v√≠deo.</p></div></div>
</div></div></div>

<!-- TIMELINE -->
<div id="tab-timeline" style="display:none;"><div class="gf"><div class="cd">
  <div class="ch"><span class="ct">Timeline</span></div>
  <div class="cb"><div id="tlc"><p style="color:var(--t3);font-size:11px;text-align:center;padding:30px;">Sem dados.</p></div></div>
</div></div></div>
</main>

<!-- MODALS -->
<div class="mo" id="mDaily"><div class="ml"><div class="mh"><h2>Registrar Dados</h2><button class="mx" onclick="cM('mDaily')">‚úï</button></div><div class="mb"><div class="fg"><label class="fl">Data</label><input type="date" class="fi" id="dDate"></div><p style="font-size:10px;color:var(--t3);margin-bottom:12px;">Followers atuais. Deixe vazio para pular.</p><div id="dFields"></div></div><div class="mf"><button class="b" onclick="cM('mDaily')">Cancelar</button><button class="b b-brand" onclick="saveDailyData()">Salvar</button></div></div></div>

<div class="mo" id="mVideo"><div class="ml"><div class="mh"><h2>Registrar V√≠deo</h2><button class="mx" onclick="cM('mVideo')">‚úï</button></div><div class="mb"><div class="fr"><div class="fg"><label class="fl">Conta</label><select class="fs" id="vAcc"></select></div><div class="fg"><label class="fl">Data</label><input type="date" class="fi" id="vDate"></div></div><div class="fr"><div class="fg"><label class="fl">Hor√°rio</label><input type="time" class="fi" id="vTime"></div><div class="fg"><label class="fl">Nicho</label><input type="text" class="fi" id="vNiche" placeholder="Suplementos..."></div></div><div class="fg"><label class="fl">Notas</label><input type="text" class="fi" id="vNotes"></div></div><div class="mf"><button class="b" onclick="cM('mVideo')">Cancelar</button><button class="b b-brand" onclick="saveVideo()">Salvar</button></div></div></div>

<div class="mo" id="mNiche"><div class="ml"><div class="mh"><h2>Mudan√ßa de Nicho</h2><button class="mx" onclick="cM('mNiche')">‚úï</button></div><div class="mb"><div class="fr"><div class="fg"><label class="fl">Conta</label><select class="fs" id="nAcc"></select></div><div class="fg"><label class="fl">Data</label><input type="date" class="fi" id="nDate"></div></div><div class="fr"><div class="fg"><label class="fl">De</label><input type="text" class="fi" id="nFrom"></div><div class="fg"><label class="fl">Para</label><input type="text" class="fi" id="nTo"></div></div><div class="fg"><label class="fl">Motivo</label><input type="text" class="fi" id="nReason"></div></div><div class="mf"><button class="b" onclick="cM('mNiche')">Cancelar</button><button class="b b-brand" onclick="saveNiche()">Salvar</button></div></div></div>

<div class="mo" id="mAcc"><div class="ml"><div class="mh"><h2>Nova Conta</h2><button class="mx" onclick="cM('mAcc')">‚úï</button></div><div class="mb"><div class="fr"><div class="fg"><label class="fl">Pa√≠s</label><div style="display:flex;gap:4px;"><select class="fs" id="naC" style="flex:1;"></select><button class="b" style="font-size:9px;" onclick="cM('mAcc');openCountryModal();">+Pa√≠s</button></div></div><div class="fg"><label class="fl">ID</label><input type="text" class="fi" id="naI" placeholder="88"></div></div><div class="fg"><label class="fl">Nicho</label><input type="text" class="fi" id="naN" placeholder="Suplementos"></div></div><div class="mf"><button class="b" onclick="cM('mAcc')">Cancelar</button><button class="b b-brand" onclick="saveAcc()">Criar</button></div></div></div>

<div class="mo" id="mCountry"><div class="ml" style="width:440px;"><div class="mh"><h2>Pa√≠ses</h2><button class="mx" onclick="cM('mCountry')">‚úï</button></div><div class="mb"><div id="cList" style="margin-bottom:14px;"></div><div style="border-top:1px solid var(--brd);padding-top:12px;"><div style="font-size:10px;font-weight:700;color:var(--t3);margin-bottom:6px;text-transform:uppercase;">Novo Pa√≠s</div><div class="fr3"><div class="fg"><label class="fl">C√≥digo</label><input type="text" class="fi" id="ncCode" placeholder="BR" maxlength="5" style="text-transform:uppercase;"></div><div class="fg"><label class="fl">Nome</label><input type="text" class="fi" id="ncLabel" placeholder="Brasil"></div><div class="fg"><label class="fl">Emoji</label><input type="text" class="fi" id="ncFlag" placeholder="üáßüá∑"></div></div><div class="fg"><label class="fl">Cor</label><div style="display:flex;gap:5px;align-items:center;"><input type="color" id="ncPick" value="#3b82f6" style="width:34px;height:32px;border:none;background:none;cursor:pointer;"><input type="text" class="fi" id="ncColor" value="#3b82f6" style="flex:1;"></div></div></div></div><div class="mf"><button class="b" onclick="cM('mCountry')">Fechar</button><button class="b b-brand" onclick="saveCountry()">+ Adicionar</button></div></div></div>

<div class="mo" id="mImport"><div class="ml" style="width:480px;"><div class="mh"><h2>üì• Importar Planilha</h2><button class="mx" onclick="cM('mImport')">‚úï</button></div><div class="mb"><p style="font-size:11px;color:var(--t2);margin-bottom:10px;">Formato: <strong>Pa√≠s, Conta, data1, data2, ...</strong> (datas no cabe√ßalho, followers nos valores)</p><div class="dz" id="dZone" onclick="document.getElementById('fIn').click()"><input type="file" id="fIn" accept=".xlsx,.xls,.csv" onchange="hImport(this.files[0])"><div style="font-size:24px;margin-bottom:6px;">üìÅ</div><div style="font-weight:700;font-size:12px;">Arraste ou clique</div><div style="font-size:10px;color:var(--t3);">.xlsx, .csv</div></div><div id="iPrev" style="display:none;margin-top:10px;"></div></div><div class="mf"><button class="b" onclick="cM('mImport')">Cancelar</button><button class="b b-brand" id="bImp" style="display:none;" onclick="doImport()">Confirmar</button></div></div></div>

<div class="toast" id="toast"></div>

<script>
// =============================================
// SUPABASE CONFIG
// =============================================
// ‚ö†Ô∏è SUBSTITUA COM SUAS CREDENCIAIS DO SUPABASE
const SUPABASE_URL = 'https://czekdqppixbkrqbpvkwo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6ZWtkcXBwaXhia3JxYnB2a3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODE5MzYsImV4cCI6MjA4NzE1NzkzNn0.Sd1QmgynJMv8rWDDU3uhucBogR_2brTpQqYtTRY0J1M';

let sb, DB = { countries:[], accounts:[], daily:{}, videos:[], nicheChanges:[] };
let connected = false;

async function initSupabase() {
  if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
    console.warn('‚ö†Ô∏è Supabase n√£o configurado ‚Äî usando localStorage como fallback');
    loadLocal(); render(); return;
  }
  try {
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    await fetchAll();
    connected = true;
    document.getElementById('syncDot').title = 'Conectado ao Supabase';
    setupRealtime();
    render();
  } catch(e) {
    console.error('Supabase error:', e);
    document.getElementById('syncDot').classList.add('off');
    document.getElementById('syncDot').title = 'Offline ‚Äî usando localStorage';
    loadLocal(); render();
  }
}

// Fetch all data from Supabase
async function fetchAll() {
  const [c, a, d, v, n] = await Promise.all([
    sb.from('countries').select('*').order('created_at'),
    sb.from('accounts').select('*').order('country,id'),
    sb.from('daily_data').select('*').order('date'),
    sb.from('videos').select('*').order('date,time'),
    sb.from('niche_changes').select('*').order('date'),
  ]);
  DB.countries = c.data || [];
  DB.accounts = (a.data || []).map(r=>({id:r.id,country:r.country,niche:r.niche||'',status:r.status||'active',createdAt:r.created_at}));
  DB.daily = {};
  for(const r of (d.data||[])) { if(!DB.daily[r.date])DB.daily[r.date]={}; DB.daily[r.date][r.account_id]=r.followers; }
  DB.videos = (v.data||[]).map(r=>({id:r.id.toString(),accountId:r.account_id,date:r.date,time:r.time||'',niche:r.niche||'',notes:r.notes||''}));
  DB.nicheChanges = (n.data||[]).map(r=>({id:r.id.toString(),accountId:r.account_id,date:r.date,from:r.niche_from||'',to:r.niche_to,reason:r.reason||''}));
}

// Realtime subscriptions
function setupRealtime() {
  if(!sb) return;
  sb.channel('db-changes')
    .on('postgres_changes',{event:'*',schema:'public'},()=>{ fetchAll().then(render); })
    .subscribe();
}

// LocalStorage fallback
function loadLocal() {
  try{const r=localStorage.getItem('ace_v3');if(r){DB=JSON.parse(r);return;}}catch(e){}
  DB=getDefaultDB();
}
function saveLocal(){localStorage.setItem('ace_v3',JSON.stringify(DB));}
function getDefaultDB(){
  return{countries:[{code:'US',label:'US',flag:'üá∫üá∏',color:'#C23B3B'},{code:'UK',label:'UK',flag:'üá¨üáß',color:'#2BC5B4'},{code:'IND',label:'IND',flag:'üáÆüá©',color:'#FBBF24'},{code:'PHI',label:'PHI',flag:'üáµüá≠',color:'#A78BFA'}],
  accounts:[{id:'96',country:'US',niche:'',status:'active',createdAt:'2026-02-19'},{id:'52',country:'US',niche:'',status:'active',createdAt:'2026-02-19'},{id:'56',country:'US',niche:'',status:'active',createdAt:'2026-02-19'},{id:'58',country:'US',niche:'',status:'active',createdAt:'2026-02-19'},{id:'59',country:'US',niche:'',status:'active',createdAt:'2026-02-19'},{id:'61',country:'US',niche:'',status:'active',createdAt:'2026-02-19'},{id:'66',country:'US',niche:'',status:'active',createdAt:'2026-02-19'},{id:'85',country:'US',niche:'',status:'active',createdAt:'2026-02-19'},{id:'86',country:'US',niche:'',status:'active',createdAt:'2026-02-19'},{id:'87',country:'US',niche:'',status:'active',createdAt:'2026-02-19'},{id:'83',country:'UK',niche:'',status:'active',createdAt:'2026-02-19'},{id:'84',country:'UK',niche:'',status:'active',createdAt:'2026-02-19'},{id:'77',country:'IND',niche:'',status:'active',createdAt:'2026-02-19'},{id:'78',country:'IND',niche:'',status:'active',createdAt:'2026-02-19'},{id:'79',country:'IND',niche:'',status:'active',createdAt:'2026-02-19'},{id:'80',country:'PHI',niche:'',status:'active',createdAt:'2026-02-19'},{id:'81',country:'PHI',niche:'',status:'active',createdAt:'2026-02-19'},{id:'82',country:'PHI',niche:'',status:'active',createdAt:'2026-02-19'}],
  daily:{'2026-02-19':{'96':1381,'52':1321,'56':1313,'58':1307,'59':2144,'61':1774,'66':1902,'85':0,'86':0,'87':0,'83':0,'84':0,'77':5,'78':3,'79':0,'80':0,'81':3,'82':0}},videos:[],nicheChanges:[]};
}

// =============================================
// DB HELPERS (work with both Supabase & local)
// =============================================
const gc=c=>DB.countries.find(x=>x.code===c)||{code:c,label:c,flag:'üè≥Ô∏è',color:'#888'};
const gColor=c=>gc(c).color;
const gFlag=c=>gc(c).flag;
const dim=(h,o=.15)=>{const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return`rgba(${r},${g},${b},${o})`;};
const fmt=n=>(n==null||n==='')?'‚Äî':Number(n).toLocaleString('en-US');
const gAccs=c=>DB.accounts.filter(a=>a.country===c);
const gDates=()=>Object.keys(DB.daily).sort();
const gLast=()=>{const d=gDates();return d.length?d[d.length-1]:null;};
const gPrev=d=>{const ds=gDates();const i=ds.indexOf(d);return i>0?ds[i-1]:null;};
const gF=(id,d)=>DB.daily[d]?.[id]??null;
const gTotal=(c,d)=>{let t=0;for(const a of gAccs(c)){const v=gF(a.id,d);if(v!==null)t+=v;}return t;};
const gVC=(id,d)=>DB.videos.filter(v=>v.accountId===id&&v.date===d).length;
const gTags=(id,d)=>{const t=[];DB.nicheChanges.filter(n=>n.accountId===id&&n.date===d).forEach(n=>t.push({text:`${n.from}‚Üí${n.to}`,type:'nc'}));[...new Set(DB.videos.filter(v=>v.accountId===id&&v.date===d&&v.niche).map(v=>v.niche))].forEach(n=>t.push({text:n,type:''}));return t;};
function toast(m){const t=document.getElementById('toast');t.textContent=m||'Salvo!';t.classList.add('sh');setTimeout(()=>t.classList.remove('sh'),2500);}

// Supabase write helpers
async function dbInsert(table, data) { if(sb&&connected) return sb.from(table).insert(data); }
async function dbUpsert(table, data) { if(sb&&connected) return sb.from(table).upsert(data); }
async function dbDelete(table, match) { if(sb&&connected) return sb.from(table).delete().match(match); }

// =============================================
// THEME
// =============================================
function toggleTheme(){const h=document.documentElement,n=h.getAttribute('data-theme')==='dark'?'light':'dark';h.setAttribute('data-theme',n);localStorage.setItem('ace_theme',n);render();}
(function(){const t=localStorage.getItem('ace_theme');if(t)document.documentElement.setAttribute('data-theme',t);})();

// =============================================
// TABS & RENDER
// =============================================
function swTab(t,el){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('a'));el.classList.add('a');['overview','calendar','accounts','videos','timeline'].forEach(x=>{document.getElementById('tab-'+x).style.display=x===t?'':'none';});render(t);}
function render(t){const v=t||getVisibleTab();if(v==='overview'){rStats();bPills();rGC();rAC();iGD();rGrid();rMT('all');}if(v==='calendar')rCal();if(v==='accounts')rAccT();if(v==='videos')rVid();if(v==='timeline')rTL();}
function getVisibleTab(){for(const t of['overview','calendar','accounts','videos','timeline'])if(document.getElementById('tab-'+t).style.display!=='none')return t;return'overview';}

let gCh,aCh,odCh;

function rStats(){
  const l=gLast(),p=l?gPrev(l):null,r=document.getElementById('statsRow');let h='';
  for(const c of DB.countries){const ac=gAccs(c.code),tt=l?gTotal(c.code,l):0;let ch='‚Äî';
    if(p){const pt=gTotal(c.code,p),df=tt-pt;if(df>0)ch=`<span class="u">‚ñ≤+${fmt(df)}</span>`;else if(df<0)ch=`<span class="d">‚ñº${fmt(df)}</span>`;else ch='<span class="cz">0</span>';}
    h+=`<div class="sc"><div class="ab" style="background:${c.color};"></div><div class="sl">${c.flag} ${c.label} ‚Äî ${ac.length} contas</div><div class="sv">${fmt(tt)}</div><div class="ss">followers ${ch}</div></div>`;}
  r.innerHTML=h;r.style.gridTemplateColumns=`repeat(${Math.min(DB.countries.length,5)},1fr)`;
}

function bPills(){
  const mk=(id,fn)=>{let h=`<span class="pl a" style="background:var(--t3);color:#fff;" onclick="${fn}('all',this)">Todos</span>`;for(const c of DB.countries)h+=`<span class="pl" onclick="${fn}('${c.code}',this)">${c.label}</span>`;document.getElementById(id).innerHTML=h;};
  mk('cpf','tCF');mk('ocp','sOC');mk('tcf','fTb');
  document.getElementById('ccf').innerHTML='<option value="all">Todos</option>'+DB.countries.map(c=>`<option value="${c.code}">${c.flag} ${c.label}</option>`).join('');
}

function aPill(cid,c){document.querySelectorAll(`#${cid} .pl`).forEach(p=>{p.classList.remove('a');p.style.background='';p.style.color='';});event.target.classList.add('a');if(c!=='all'){const cl=gColor(c);event.target.style.background=cl;event.target.style.borderColor=cl;event.target.style.color='#fff';}else{event.target.style.background='var(--t3)';event.target.style.color='#fff';}}
function tCF(c){aPill('cpf',c);rGC(c);}
let ctf='all';function fTb(c){aPill('tcf',c);ctf=c;rMT(c);}
function sOC(c){ogC=c;aPill('ocp',c);rGrid();}
let ogC='all',ogM='hm';
function sGM(m,el){ogM=m;document.querySelectorAll('#omp .pl').forEach(p=>{p.classList.remove('a');p.style.background='';p.style.color='';});el.classList.add('a');el.style.background='var(--t3)';el.style.color='#fff';rGrid();}

const cOpt=()=>({responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:getComputedStyle(document.documentElement).getPropertyValue('--t3').trim(),font:{family:'Plus Jakarta Sans',size:9},boxWidth:8,padding:8}}},scales:{x:{ticks:{color:getComputedStyle(document.documentElement).getPropertyValue('--t3').trim(),font:{family:'JetBrains Mono',size:8}},grid:{color:getComputedStyle(document.documentElement).getPropertyValue('--brd').trim()}},y:{ticks:{color:getComputedStyle(document.documentElement).getPropertyValue('--t3').trim(),font:{family:'JetBrains Mono',size:8}},grid:{color:getComputedStyle(document.documentElement).getPropertyValue('--brd').trim()}}},interaction:{intersect:false,mode:'index'}});

function rGC(f='all'){
  const d=gDates(),cs=f==='all'?DB.countries:DB.countries.filter(c=>c.code===f);
  const ds=cs.map(c=>({label:c.label,data:d.map(dt=>gTotal(c.code,dt)),borderColor:c.color,backgroundColor:c.color+'20',borderWidth:2,fill:true,tension:.3,pointRadius:d.length<15?3:1,pointBackgroundColor:c.color}));
  if(gCh)gCh.destroy();gCh=new Chart(document.getElementById('gChart'),{type:'line',data:{labels:d.map(x=>x.slice(5)),datasets:ds},options:cOpt()});
}

function rAC(){
  const d=gDates(),l=gLast(),all=DB.accounts.filter(a=>l&&gF(a.id,l)>0).sort((a,b)=>(gF(b.id,l)||0)-(gF(a.id,l)||0)).slice(0,10);
  const p=['#C23B3B','#2BC5B4','#FBBF24','#A78BFA','#F87171','#34D399','#60A5FA','#F472B6','#FB923C','#818CF8'];
  const ds=all.map((a,i)=>({label:`${a.country}#${a.id}`,data:d.map(dt=>gF(a.id,dt)||0),borderColor:p[i%p.length],borderWidth:2,fill:false,tension:.3,pointRadius:d.length<15?2:0}));
  if(aCh)aCh.destroy();aCh=new Chart(document.getElementById('aChart'),{type:'line',data:{labels:d.map(x=>x.slice(5)),datasets:ds},options:cOpt()});
}

function iGD(){const d=gDates(),f=document.getElementById('ogF'),t=document.getElementById('ogT');if(d.length){if(!f.value)f.value=d[0];if(!t.value)t.value=d[d.length-1];}}

function rGrid(){
  const ad=gDates(),fr=document.getElementById('ogF').value,to=document.getElementById('ogT').value;
  const dates=ad.filter(d=>(!fr||d>=fr)&&(!to||d<=to));
  if(!dates.length){document.getElementById('ogC').innerHTML='<p style="color:var(--t3);text-align:center;padding:24px;font-size:11px;">Sem dados.</p>';document.getElementById('ogW').style.display='';document.getElementById('ocW').style.display='none';return;}
  const cs=ogC==='all'?DB.countries.map(c=>c.code):[ogC];
  if(ogM==='ch'){document.getElementById('ogW').style.display='none';document.getElementById('ocW').style.display='';rODC(dates,cs);return;}
  document.getElementById('ogW').style.display='';document.getElementById('ocW').style.display='none';
  let mx=0;for(const c of cs)for(const a of gAccs(c))for(const d of dates){const v=gF(a.id,d);if(v&&v>mx)mx=v;}
  const td=new Date().toISOString().split('T')[0],nc=dates.length;
  let h=`<div class="cg" style="grid-template-columns:100px repeat(${nc},minmax(55px,1fr));">`;
  h+=`<div class="ccr">Conta</div>`;
  for(const d of dates){const dn=d.slice(8),mn=d.slice(5,7),dy=new Date(d+'T12:00:00').toLocaleDateString('pt-BR',{weekday:'short'}).slice(0,3);h+=`<div class="chc${d===td?' td':''}">${dy}<br>${dn}/${mn}</div>`;}
  for(const c of cs){const cl=gColor(c);h+=`<div class="cdv" style="grid-column:1/span ${nc+1};background:${dim(cl)};color:${cl};">${gFlag(c)} ${c}</div>`;
    for(const a of gAccs(c)){h+=`<div class="crl"><span style="color:${cl};font-weight:700;">${a.id}</span></div>`;
      for(let i=0;i<dates.length;i++){const d=dates[i],v=gF(a.id,d),hv=DB.videos.some(x=>x.accountId===a.id&&x.date===d);let int=0;if(v&&mx>0)int=v/mx;
        const dp=v!=null?fmt(v):'‚Äî',tc=v===0||v==null?'var(--t3)':'var(--t1)';
        h+=`<div class="hmc${hv?' hv':''}" title="#${a.id} ${d}"><div class="bg" style="background:${cl};opacity:${(int*.35).toFixed(2)};"></div><span class="vl" style="color:${tc};">${dp}</span></div>`;}}
    h+=`<div class="crl" style="font-size:8px;color:var(--t3);font-weight:700;background:var(--bg-2);">Œ£${c}</div>`;
    for(const d of dates)h+=`<div class="hmc" style="background:var(--bg-2);"><span class="vl" style="font-weight:700;font-size:10px;">${fmt(gTotal(c,d))}</span></div>`;}
  h+='</div>';document.getElementById('ogC').innerHTML=h;
  const s=document.getElementById('ogW').querySelector('.csc');if(s)s.scrollLeft=s.scrollWidth;
}

function rODC(dates,cs){
  const p=['#C23B3B','#2BC5B4','#FBBF24','#A78BFA','#F87171','#34D399','#60A5FA','#F472B6','#FB923C','#818CF8','#E879F9','#22D3EE'];
  let i=0;const ds=[];
  for(const c of cs)for(const a of gAccs(c)){if(!dates.some(d=>{const v=gF(a.id,d);return v&&v>0;}))continue;ds.push({label:`${c}#${a.id}`,data:dates.map(d=>gF(a.id,d)||0),borderColor:p[i%p.length],borderWidth:2,fill:false,tension:.3,pointRadius:dates.length<20?2:0});i++;}
  if(odCh)odCh.destroy();odCh=new Chart(document.getElementById('odChart'),{type:'line',data:{labels:dates.map(d=>d.slice(5).replace('-','/')),datasets:ds},options:cOpt()});
}

function rMT(cf){
  const tb=document.getElementById('mtb'),d=gDates().reverse(),ac=cf==='all'?DB.accounts:DB.accounts.filter(a=>a.country===cf);let h='';
  for(const dt of d)for(const a of ac){const f=gF(a.id,dt);if(f===null)continue;const p=gPrev(dt);let ch='‚Äî',cc='cz';
    if(p){const pf=gF(a.id,p);if(pf!==null){const df=f-pf;if(df>0){ch=`+${fmt(df)}`;cc='cp';}else if(df<0){ch=fmt(df);cc='cn';}else ch='0';}}
    const cl=gColor(a.country),vc=gVC(a.id,dt),tg=gTags(a.id,dt).map(t=>`<span class="tag ${t.type}">${t.text}</span>`).join('');
    h+=`<tr><td><span class="badge" style="background:${dim(cl)};color:${cl};">${gFlag(a.country)} ${a.country}</span></td><td style="font-weight:700;">${a.id}</td><td>${dt}</td><td style="font-weight:700;">${fmt(f)}</td><td class="${cc}">${ch}</td><td>${vc||'‚Äî'}</td><td>${tg||'‚Äî'}</td></tr>`;}
  tb.innerHTML=h||'<tr><td colspan="7" style="text-align:center;color:var(--t3);padding:24px;">Sem dados.</td></tr>';
}

// Calendar
let cdM='f';
function sCD(m,el){cdM=m;document.querySelectorAll('#cdm .pl').forEach(p=>{p.classList.remove('a');p.style.background='';p.style.color='';});el.classList.add('a');el.style.background='var(--t3)';el.style.color='#fff';rCal();}

function rCal(){
  const ct=document.getElementById('cGrid'),cf=document.getElementById('ccf').value,dates=gDates(),td=new Date().toISOString().split('T')[0];
  if(!dates.length){ct.innerHTML='<p style="color:var(--t3);text-align:center;padding:30px;font-size:11px;">Sem dados.</p>';return;}
  const cs=cf==='all'?DB.countries.map(c=>c.code):[cf],gs=[];for(const c of cs){const a=gAccs(c);if(a.length)gs.push({c,a});}
  const nc=dates.length+1;
  let h=`<div class="cg" style="grid-template-columns:110px repeat(${dates.length},minmax(60px,1fr));">`;
  h+=`<div class="ccr">Conta / Data</div>`;
  for(const d of dates){const dy=new Date(d+'T12:00:00').toLocaleDateString('pt-BR',{weekday:'short'}),dn=d.slice(8),mn=d.slice(5,7);h+=`<div class="chc${d===td?' td':''}">${dy}<br>${dn}/${mn}</div>`;}
  for(const g of gs){const cl=gColor(g.c);h+=`<div class="cdv" style="grid-column:1/span ${nc};background:${dim(cl)};color:${cl};">${gFlag(g.c)} ${g.c} ‚Äî ${g.a.length}</div>`;
    for(const a of g.a){h+=`<div class="crl"><span class="badge" style="background:${dim(cl)};color:${cl};font-size:8px;padding:1px 4px;">${g.c}</span>${a.id}</div>`;
      for(let i=0;i<dates.length;i++){const d=dates[i],v=gF(a.id,d),hv=DB.videos.some(x=>x.accountId===a.id&&x.date===d);let cls='ccl';if(hv)cls+=' hv';let dp='',st='';
        if(cdM==='f'){if(v==null){dp='‚Äî';st='color:var(--t3);opacity:.4';}else if(v===0){dp='0';st='color:var(--t3);';}else{dp=fmt(v);st='font-weight:700;';}}
        else if(cdM==='d'){if(i===0||v==null){dp='‚Äî';st='color:var(--t3);';}else{const pv=gF(a.id,dates[i-1]);if(pv==null){dp='‚Äî';st='color:var(--t3);';}else{const df=v-pv;if(df>0){dp='+'+fmt(df);st='color:var(--green);font-weight:700;';}else if(df<0){dp=fmt(df);st='color:var(--red);font-weight:700;';}else{dp='0';st='color:var(--t3);';}}}}
        else{const cnt=gVC(a.id,d);dp=cnt>0?cnt+'üé¨':'‚Äî';st=cnt>0?'font-weight:700;':'color:var(--t3);opacity:.4;';}
        h+=`<div class="${cls}" data-a="${a.id}" data-d="${d}" ondblclick="eCal(this)"><span style="${st}">${dp}</span></div>`;}}
    h+=`<div class="crl" style="font-weight:700;font-size:9px;color:var(--t3);background:var(--bg-2);">Œ£${g.c}</div>`;
    for(const d of dates)h+=`<div class="ccl" style="background:var(--bg-2);font-weight:700;font-size:10px;">${fmt(gTotal(g.c,d))}</div>`;}
  if(cf==='all'){h+=`<div class="cdv" style="grid-column:1/span ${nc};background:var(--bg-3);color:var(--t1);">üìä TOTAL</div>`;
    h+=`<div class="crl" style="font-weight:700;font-size:9px;background:var(--bg-2);">ALL</div>`;
    for(const d of dates){let g=0;for(const c of DB.countries)g+=gTotal(c.code,d);h+=`<div class="ccl" style="background:var(--bg-2);font-weight:700;font-size:10px;color:var(--brand);">${fmt(g)}</div>`;}}
  h+='</div>';ct.innerHTML=h;document.getElementById('cScr').scrollLeft=9999;
}

async function eCal(cell){
  if(cell.querySelector('input'))return;const id=cell.dataset.a,d=cell.dataset.d;if(!id||!d)return;
  const cv=gF(id,d),inp=document.createElement('input');inp.type='number';inp.value=cv!==null?cv:'';inp.placeholder='0';
  cell.innerHTML='';cell.appendChild(inp);inp.focus();inp.select();
  const save=async()=>{const nv=inp.value.trim();if(nv!==''){if(!DB.daily[d])DB.daily[d]={};DB.daily[d][id]=parseInt(nv);
    const acc=DB.accounts.find(a=>a.id===id);if(acc)await dbUpsert('daily_data',{account_id:id,account_country:acc.country,date:d,followers:parseInt(nv)});saveLocal();}rCal();};
  inp.addEventListener('blur',save);inp.addEventListener('keydown',e=>{if(e.key==='Enter')save();if(e.key==='Escape')rCal();});
}

function rAccT(){
  const tb=document.getElementById('atb'),l=gLast();let h='';
  for(const a of DB.accounts){const f=l?(gF(a.id,l)||0):0,cl=gColor(a.country);
    const ln=DB.nicheChanges.filter(n=>n.accountId===a.id).pop();const cn=ln?ln.to:(a.niche||'‚Äî');
    h+=`<tr><td><span class="badge" style="background:${dim(cl)};color:${cl};">${gFlag(a.country)} ${a.country}</span></td><td style="font-weight:700;">${a.id}</td><td>${cn}</td><td style="font-weight:700;">${fmt(f)}</td><td>${a.createdAt||'‚Äî'}</td><td><span class="tag" style="background:${dim('#34D399')};color:#34D399;">active</span></td><td><button class="b" style="font-size:8px;padding:3px 6px;color:var(--red);border-color:var(--red);" onclick="delAcc('${a.id}','${a.country}')">√ó</button></td></tr>`;}
  tb.innerHTML=h;
}

async function delAcc(id,c){if(!confirm(`Remover conta ${id}?`))return;DB.accounts=DB.accounts.filter(a=>!(a.id===id&&a.country===c));for(const d of Object.keys(DB.daily))delete DB.daily[d][id];await dbDelete('accounts',{id,country:c});saveLocal();rAccT();toast('Removida');}

function rVid(){
  const ct=document.getElementById('vlc');if(!DB.videos.length&&!DB.nicheChanges.length){ct.innerHTML='<p style="color:var(--t3);font-size:11px;text-align:center;padding:30px;">Nenhum v√≠deo.</p>';return;}
  const ev=[];
  DB.videos.forEach(v=>{const a=DB.accounts.find(x=>x.id===v.accountId);ev.push({...v,type:'v',country:a?a.country:'?'});});
  DB.nicheChanges.forEach(n=>{const a=DB.accounts.find(x=>x.id===n.accountId);ev.push({date:n.date,time:'00:00',type:'n',accountId:n.accountId,country:a?a.country:'?',from:n.from,to:n.to,reason:n.reason});});
  ev.sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time));
  let h='',cd='';
  for(const e of ev){if(e.date!==cd){cd=e.date;h+=`<div style="font-size:10px;font-weight:800;color:var(--t3);margin:12px 0 5px;text-transform:uppercase;letter-spacing:.8px;">${e.date}</div>`;}
    const cl=gColor(e.country);
    if(e.type==='v')h+=`<div class="vli"><span class="vlt">${e.time||'‚Äî'}</span><div style="flex:1;"><div style="font-weight:600;margin-bottom:1px;"><span class="badge" style="background:${dim(cl)};color:${cl};font-size:8px;">${gFlag(e.country)} ${e.country}</span> #${e.accountId}</div><div style="color:var(--t3);font-size:9px;">${e.niche?`<span class="tag">${e.niche}</span>`:''} ${e.notes||''}</div></div></div>`;
    else h+=`<div class="vli" style="border-color:var(--amber);"><span class="vlt" style="color:var(--amber);">üîÑ</span><div style="flex:1;"><div style="font-weight:600;margin-bottom:1px;"><span class="badge" style="background:${dim(cl)};color:${cl};font-size:8px;">${gFlag(e.country)} ${e.country}</span> #${e.accountId}</div><div style="color:var(--t3);font-size:9px;"><span class="tag nc">${e.from}‚Üí${e.to}</span> ${e.reason||''}</div></div></div>`;}
  ct.innerHTML=h;
}

function rTL(){
  const ct=document.getElementById('tlc'),d=gDates().reverse();if(!d.length){ct.innerHTML='<p style="color:var(--t3);font-size:11px;text-align:center;padding:30px;">Sem dados.</p>';return;}
  let h='';for(const dt of d){const vc=DB.videos.filter(v=>v.date===dt).length,nc=DB.nicheChanges.filter(n=>n.date===dt).length;let tf=0;for(const a of DB.accounts){const f=gF(a.id,dt);if(f)tf+=f;}
    h+=`<div style="display:flex;gap:12px;margin-bottom:10px;"><div style="min-width:80px;font-family:var(--mono);font-size:11px;font-weight:700;color:var(--brand);">${dt}</div><div style="flex:1;padding:8px;border:1px solid var(--brd);border-radius:var(--radius-sm);"><div style="font-weight:700;font-size:12px;margin-bottom:2px;">${fmt(tf)} followers</div><div style="font-size:10px;color:var(--t3);">${vc?`üé¨${vc} `:''}${nc?`üîÑ${nc} `:''}${!vc&&!nc?'Dados registrados':''}</div></div></div>`;}
  ct.innerHTML=h;
}

// =============================================
// MODALS
// =============================================
function oM(id){document.getElementById(id).classList.add('a');} function cM(id){document.getElementById(id).classList.remove('a');}
document.querySelectorAll('.mo').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('a');}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.mo.a').forEach(m=>m.classList.remove('a'));});

function openDailyModal(){
  document.getElementById('dDate').value=new Date().toISOString().split('T')[0];
  const ct=document.getElementById('dFields');let h='';
  for(const c of DB.countries){const ac=gAccs(c.code);if(!ac.length)continue;h+=`<div style="margin-bottom:12px;"><div style="font-size:11px;font-weight:700;margin-bottom:5px;color:${c.color};">${c.flag} ${c.label}</div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:5px;">`;
    for(const a of ac){const lv=gLast()?(gF(a.id,gLast())||''):'';h+=`<div><label style="font-size:9px;color:var(--t3);display:block;margin-bottom:1px;">#${a.id}</label><input type="number" class="fi df" data-a="${a.id}" data-c="${a.country}" placeholder="${lv}" style="padding:5px 7px;font-size:11px;"></div>`;}
    h+=`</div></div>`;}
  ct.innerHTML=h;oM('mDaily');
}

async function saveDailyData(){
  const d=document.getElementById('dDate').value;if(!d)return toast('Selecione data');
  if(!DB.daily[d])DB.daily[d]={};
  const rows=[];
  document.querySelectorAll('.df').forEach(inp=>{const id=inp.dataset.a,c=inp.dataset.c,v=inp.value.trim();if(v!==''){DB.daily[d][id]=parseInt(v);rows.push({account_id:id,account_country:c,date:d,followers:parseInt(v)});}});
  if(rows.length)await dbUpsert('daily_data',rows);
  saveLocal();cM('mDaily');toast('Salvo!');render();
}

function openVideoModal(){document.getElementById('vAcc').innerHTML=DB.accounts.map(a=>`<option value="${a.id}" data-c="${a.country}">${gFlag(a.country)} ${a.country} #${a.id}</option>`).join('');document.getElementById('vDate').value=new Date().toISOString().split('T')[0];document.getElementById('vTime').value='';document.getElementById('vNiche').value='';document.getElementById('vNotes').value='';oM('mVideo');}
async function saveVideo(){
  const sel=document.getElementById('vAcc'),id=sel.value,c=sel.selectedOptions[0]?.dataset.c||'',d=document.getElementById('vDate').value,t=document.getElementById('vTime').value,n=document.getElementById('vNiche').value.trim(),no=document.getElementById('vNotes').value.trim();
  if(!d)return toast('Selecione data');DB.videos.push({id:Date.now().toString(),accountId:id,date:d,time:t,niche:n,notes:no});
  await dbInsert('videos',{account_id:id,account_country:c,date:d,time:t,niche:n,notes:no});
  saveLocal();cM('mVideo');toast('V√≠deo salvo!');render();
}

function openNicheModal(){document.getElementById('nAcc').innerHTML=DB.accounts.map(a=>`<option value="${a.id}" data-c="${a.country}">${gFlag(a.country)} ${a.country} #${a.id}</option>`).join('');document.getElementById('nDate').value=new Date().toISOString().split('T')[0];document.getElementById('nFrom').value='';document.getElementById('nTo').value='';document.getElementById('nReason').value='';oM('mNiche');}
async function saveNiche(){
  const sel=document.getElementById('nAcc'),id=sel.value,c=sel.selectedOptions[0]?.dataset.c||'',d=document.getElementById('nDate').value,f=document.getElementById('nFrom').value.trim(),t=document.getElementById('nTo').value.trim(),r=document.getElementById('nReason').value.trim();
  if(!d||!t)return toast('Preencha nicho');DB.nicheChanges.push({id:Date.now().toString(),accountId:id,date:d,from:f,to:t,reason:r});
  await dbInsert('niche_changes',{account_id:id,account_country:c,date:d,niche_from:f,niche_to:t,reason:r});
  saveLocal();cM('mNiche');toast('Nicho salvo!');render();
}

function openAccModal(){document.getElementById('naC').innerHTML=DB.countries.map(c=>`<option value="${c.code}">${c.flag} ${c.label}</option>`).join('');document.getElementById('naI').value='';document.getElementById('naN').value='';oM('mAcc');}
async function saveAcc(){
  const c=document.getElementById('naC').value,id=document.getElementById('naI').value.trim(),n=document.getElementById('naN').value.trim();
  if(!id)return toast('Insira ID');if(DB.accounts.find(a=>a.id===id&&a.country===c))return toast('Existe!');
  DB.accounts.push({id,country:c,niche:n,status:'active',createdAt:new Date().toISOString().split('T')[0]});
  await dbInsert('accounts',{id,country:c,niche:n});saveLocal();cM('mAcc');toast(`#${id} criada!`);render();
}

function openCountryModal(){
  rCList();document.getElementById('ncCode').value='';document.getElementById('ncLabel').value='';document.getElementById('ncFlag').value='';document.getElementById('ncColor').value='#3b82f6';document.getElementById('ncPick').value='#3b82f6';
  document.getElementById('ncPick').onchange=function(){document.getElementById('ncColor').value=this.value;};
  document.getElementById('ncColor').oninput=function(){if(/^#[0-9a-fA-F]{6}$/.test(this.value))document.getElementById('ncPick').value=this.value;};
  oM('mCountry');
}
function rCList(){
  const ct=document.getElementById('cList');let h='';
  for(let i=0;i<DB.countries.length;i++){const c=DB.countries[i],n=gAccs(c.code).length;
    h+=`<div style="display:flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--brd);border-radius:var(--radius-sm);margin-bottom:4px;"><div style="width:12px;height:12px;border-radius:3px;background:${c.color};"></div><span style="font-size:14px;">${c.flag}</span><div style="flex:1;"><span style="font-weight:700;font-size:11px;">${c.label}</span> <span style="color:var(--t3);font-size:9px;">${n}contas</span></div>${n===0?`<button class="b" style="font-size:8px;padding:2px 6px;color:var(--red);border-color:var(--red);" onclick="delC(${i})">√ó</button>`:''}</div>`;}
  ct.innerHTML=h||'<p style="color:var(--t3);font-size:10px;">Nenhum pa√≠s.</p>';
}
async function saveCountry(){
  const code=document.getElementById('ncCode').value.trim().toUpperCase(),label=document.getElementById('ncLabel').value.trim(),flag=document.getElementById('ncFlag').value.trim()||'üè≥Ô∏è',color=document.getElementById('ncColor').value.trim();
  if(!code||!label)return toast('Preencha c√≥digo e nome');if(DB.countries.find(c=>c.code===code))return toast('Existe!');if(!/^#[0-9a-fA-F]{6}$/.test(color))return toast('Cor inv√°lida');
  DB.countries.push({code,label,flag,color});await dbInsert('countries',{code,label,flag,color});saveLocal();toast(`${flag}${label} adicionado!`);rCList();bPills();
}
async function delC(i){const c=DB.countries[i];if(gAccs(c.code).length)return toast('Remova contas primeiro');DB.countries.splice(i,1);await dbDelete('countries',{code:c.code});saveLocal();toast(`${c.label} removido`);rCList();bPills();}

// =============================================
// IMPORT
// =============================================
let pendImp=null;
function openImportModal(){document.getElementById('iPrev').style.display='none';document.getElementById('bImp').style.display='none';document.getElementById('fIn').value='';pendImp=null;oM('mImport');}
const dz=document.getElementById('dZone');dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dg');});dz.addEventListener('dragleave',()=>dz.classList.remove('dg'));dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('dg');if(e.dataTransfer.files.length)hImport(e.dataTransfer.files[0]);});

function hImport(f){if(!f)return;const ext=f.name.split('.').pop().toLowerCase();
  if(ext==='csv'){const r=new FileReader();r.onload=e=>pCSV(e.target.result);r.readAsText(f);}
  else{const r=new FileReader();r.onload=e=>{const wb=XLSX.read(e.target.result,{type:'array'});pCSV(XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]));};r.readAsArrayBuffer(f);}}

function pCSV(csv){const ls=csv.trim().split('\n').map(l=>l.split(',').map(c=>c.trim()));if(ls.length<2)return toast('Vazio');
  const hd=ls[0],dates=hd.slice(2),rows=ls.slice(1).filter(r=>r.length>=3).map(r=>({country:r[0],accountId:r[1],values:r.slice(2).map(v=>v===''?null:parseInt(v))}));
  pendImp={dates,rows};
  document.getElementById('iPrev').style.display='';document.getElementById('iPrev').innerHTML=`<div style="background:var(--bg-2);border:1px solid var(--brd);border-radius:var(--radius-sm);padding:10px;"><div style="font-weight:700;font-size:11px;color:var(--complement);">‚úì ${rows.length} contas ‚Ä¢ ${dates.length} datas</div><div style="font-size:10px;color:var(--t2);">${dates[0]} ‚Üí ${dates[dates.length-1]}</div></div>`;
  document.getElementById('bImp').style.display='';
}

async function doImport(){if(!pendImp)return;const{dates,rows}=pendImp;
  for(const r of rows){
    if(!DB.countries.find(c=>c.code===r.country)){const cls=['#C23B3B','#2BC5B4','#FBBF24','#A78BFA','#F87171','#34D399'];DB.countries.push({code:r.country,label:r.country,flag:'üè≥Ô∏è',color:cls[DB.countries.length%cls.length]});await dbInsert('countries',{code:r.country,label:r.country,flag:'üè≥Ô∏è',color:cls[DB.countries.length%cls.length]});}
    if(!DB.accounts.find(a=>a.id===r.accountId&&a.country===r.country)){DB.accounts.push({id:r.accountId,country:r.country,niche:'',status:'active',createdAt:new Date().toISOString().split('T')[0]});await dbInsert('accounts',{id:r.accountId,country:r.country});}
    const batch=[];for(let i=0;i<dates.length;i++){const d=dates[i],v=r.values[i];if(v==null||isNaN(v))continue;if(!DB.daily[d])DB.daily[d]={};DB.daily[d][r.accountId]=v;batch.push({account_id:r.accountId,account_country:r.country,date:d,followers:v});}
    if(batch.length)await dbUpsert('daily_data',batch);
  }
  saveLocal();cM('mImport');toast(`Importado! ${rows.length} contas`);pendImp=null;render();
}

function exportCSV(){const d=gDates();let csv='Pa√≠s,Conta,'+d.join(',')+'\n';for(const a of DB.accounts){const r=[a.country,a.id];for(const dt of d){const v=gF(a.id,dt);r.push(v!=null?v:'');}csv+=r.join(',')+'\n';}const b=new Blob([csv],{type:'text/csv'}),u=URL.createObjectURL(b),el=document.createElement('a');el.href=u;el.download=`digital_ace_${new Date().toISOString().split('T')[0]}.csv`;el.click();URL.revokeObjectURL(u);toast('Exportado!');}

// =============================================
// INIT
// =============================================
initSupabase();
</script>
</body>
</html>
